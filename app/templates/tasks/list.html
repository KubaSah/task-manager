{% extends 'base.html' %}
{% block title %}Zadania{% endblock %}
{% block section_title %}Zadania{% endblock %}
{% block content %}
<div
    style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; gap:10px; flex-wrap:wrap;">
    <h1 style="margin:0;">Zadania</h1>
    <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
        <form method="get" action="{{ url_for('tasks.list_tasks') }}" id="filter-form" class="filter-bar">
            <input type="search" name="q" placeholder="Szukaj…" value="{{ request.args.get('q','') }}"
                class="filter-input" style="max-width:180px;" />
            <select name="status" class="filter-select" style="max-width:140px;">
                {% if not request.args.get('status') %}
                <option value="" selected disabled>Status</option>
                {% endif %}
                <option value="todo" {% if request.args.get('status')=='todo' %}selected{% endif %}>TODO</option>
                <option value="in_progress" {% if request.args.get('status')=='in_progress' %}selected{% endif %}>W
                    trakcie</option>
                <option value="done" {% if request.args.get('status')=='done' %}selected{% endif %}>Zrobione</option>
            </select>
            <select name="priority" class="filter-select" style="max-width:130px;">
                {% if not request.args.get('priority') %}
                <option value="" selected disabled>Priorytet</option>
                {% endif %}
                <option value="low" {% if request.args.get('priority')=='low' %}selected{% endif %}>Niski</option>
                <option value="medium" {% if request.args.get('priority')=='medium' %}selected{% endif %}>Średni
                </option>
                <option value="high" {% if request.args.get('priority')=='high' %}selected{% endif %}>Wysoki</option>
            </select>
            <select name="project" class="filter-select" style="max-width:150px;">
                {% if not selected_project %}
                <option value="" selected disabled>Projekt</option>
                {% endif %}
                {% for p in projects %}
                <option value="{{ p.id }}" {% if selected_project==p.id %}selected{% endif %}>{{ p.key }}</option>
                {% endfor %}
            </select>
            <button type="submit" style="display:none;"></button>
            {% if request.args.get('q') or request.args.get('status') or request.args.get('priority') or
            request.args.get('project') %}
            <a class="btn" href="{{ url_for('tasks.list_tasks') }}" style="font-size:13px; padding:7px 10px;">✕</a>
            {% endif %}
        </form>
        <a class="btn btn-primary" href="{{ url_for('tasks.create_task') }}"
            style="white-space:nowrap; font-size:13px; padding:7px 12px;">+ Zadanie</a>
    </div>
</div>
<div class="board">
    {% set grouped = {'todo': [], 'in_progress': [], 'done': []} %}
    {% for t in tasks %}
    {% set _ = grouped[t.status].append(t) %}
    {% endfor %}
    {% for col, label in [('todo','Do zrobienia'), ('in_progress','W toku'), ('done','Zrobione')] %}
    <div class="column" data-status="{{ col }}">
        <div class="column-header">{{ label }} <span class="chip {{ col }}">{{ grouped[col]|length }}</span></div>
        {% for t in grouped[col] %}
        <div class="card task-card" draggable="true" data-task-id="{{ t.id }}">
            <div class="task-title"><a style="color:inherit; text-decoration:none;"
                    href="{{ url_for('tasks.task_detail', task_id=t.id) }}">#{{ t.id }} {{ t.title }}</a></div>
            <div class="meta">Priorytet: {{ t.priority }}</div>
            {% if t.description %}<div class="muted" style="font-size:12px">{{ t.description[:140] }}{% if
                t.description|length > 140 %}…{% endif %}</div>{% endif %}
        </div>
        {% else %}
        <div class="card" style="opacity:.5"><em>Brak</em></div>
        {% endfor %}
    </div>
    {% endfor %}
</div>
{% block scripts %}
<script nonce="{{ g.csp_nonce }}">
    (function () {
        // Auto-submit filters without inline handlers (CSP friendly)
        const form = document.getElementById('filter-form');
        if (form) {
            const submitNow = () => form.requestSubmit ? form.requestSubmit() : form.submit();
            // Change on selects triggers submit
            form.querySelectorAll('select.filter-select').forEach(sel => {
                sel.addEventListener('change', submitNow);
            });
            // Debounced typing in search
            const q = form.querySelector('input[name="q"]');
            let t;
            if (q) {
                q.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitNow();
                    }
                });
                q.addEventListener('input', () => {
                    clearTimeout(t);
                    t = setTimeout(submitNow, 400);
                });
            }
        }

        const getToken = () => document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const board = document.querySelector('.board');
        if (!board) return;

        // Drag events
        let draggedCard = null;
        board.addEventListener('dragstart', (e) => {
            const card = e.target.closest('.task-card');
            if (!card) return;
            draggedCard = card;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', card.dataset.taskId);
            card.style.opacity = '0.6';
        });
        board.addEventListener('dragend', (e) => {
            const card = e.target.closest('.task-card');
            if (card) card.style.opacity = '';
            draggedCard = null;
        });

        board.querySelectorAll('.column').forEach(col => {
            col.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            col.addEventListener('drop', async (e) => {
                e.preventDefault();
                const taskId = e.dataTransfer.getData('text/plain');
                const newStatus = col.dataset.status;
                if (!taskId || !newStatus || !draggedCard) return;

                // Preserve reference to the card before async operations
                const cardToMove = draggedCard;
                const originalParent = cardToMove.parentElement;

                try {
                    const body = new URLSearchParams();
                    body.set('status', newStatus);
                    const resp = await fetch(`/tasks/${taskId}/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                            'X-CSRF-Token': getToken(),
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body
                    });

                    if (resp.ok) {
                        // Try parse JSON, but if it's redirect or HTML, just trust HTTP 200
                        let data = null;
                        const contentType = resp.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            data = await resp.json();
                        }

                        if (!data || data.ok !== false) {
                            // Success: move card if still valid DOM element and target exists
                            if (cardToMove && cardToMove.parentElement && col) {
                                col.appendChild(cardToMove);
                                updateCounters();
                                updatePlaceholders();
                            }
                        } else {
                            alert('Nie udało się zmienić statusu: ' + (data.error || 'unknown'));
                        }
                    } else if (resp.status === 403) {
                        alert('Brak uprawnień do zmiany statusu');
                    } else {
                        alert('Nie udało się zmienić statusu (HTTP ' + resp.status + ')');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Błąd podczas zapisu statusu');
                }
            });
        });

        function updateCounters() {
            document.querySelectorAll('.column').forEach(col => {
                const status = col.dataset.status;
                const count = col.querySelectorAll('.task-card').length;
                const badge = col.querySelector('.column-header .chip');
                if (badge) badge.textContent = count;
            });
        }

        function updatePlaceholders() {
            document.querySelectorAll('.column').forEach(col => {
                const taskCards = col.querySelectorAll('.task-card');
                let placeholder = col.querySelector('.card:not(.task-card)');

                if (taskCards.length === 0) {
                    // No tasks - add placeholder if missing
                    if (!placeholder) {
                        placeholder = document.createElement('div');
                        placeholder.className = 'card';
                        placeholder.style.opacity = '0.5';
                        placeholder.innerHTML = '<em>Brak</em>';
                        col.appendChild(placeholder);
                    }
                } else {
                    // Has tasks - remove placeholder if exists
                    if (placeholder) {
                        placeholder.remove();
                    }
                }
            });
        }
    })();
</script>
{% endblock %}
{% endblock %}