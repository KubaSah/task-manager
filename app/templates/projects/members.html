{% extends 'base.html' %}
{% block title %}Członkowie projektu {{ project.key }}{% endblock %}
{% block section_title %}Członkowie: {{ project.key }}{% endblock %}
{% block content %}
<div class="members-header">
    <h1>{{ project.name }}</h1>
    <div class="members-header-buttons">
        <a class="btn" href="{{ url_for('projects.project_detail', project_id=project.id) }}">Powrót</a>
    </div>
</div>
<div class="card members-list-card">
    <h2 class="members-section-title">Lista członków</h2>
    <div class="grid members-grid">
        {% for m in memberships %}
        <div class="card member-card">
            <div class="member-card-row">
                <div class="member-info">
                    <strong>{{ m.user.name }}</strong>
                    <span class="meta">{{ m.user.email }}</span>
                    <span class="chip">Rola: {{ m.role }}</span>
                </div>
                {% if can_manage and m.role != 'owner' %}
                <form method="post"
                    action="{{ url_for('projects.change_member_role', project_id=project.id, membership_id=m.id) }}"
                    class="member-role-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <select name="role">
                        <option value="admin" {% if m.role=='admin' %}selected{% endif %}>admin</option>
                        <option value="member" {% if m.role=='member' %}selected{% endif %}>member</option>
                        <option value="viewer" {% if m.role=='viewer' %}selected{% endif %}>viewer</option>
                    </select>
                    <button class="btn" type="submit">Zmień</button>
                </form>
                <form method="post"
                    action="{{ url_for('projects.remove_member', project_id=project.id, membership_id=m.id) }}"
                    data-confirm="Usunąć tego członka z projektu?">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                    <button class="btn btn-danger" type="submit">Usuń</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="muted">Brak członków projektu.</div>
        {% endfor %}
    </div>
</div>

{% if can_manage %}
<div class="card">
    <h2 class="members-section-title">Dodaj członka</h2>
    <form method="post" action="{{ url_for('projects.add_member', project_id=project.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="field">
            <label>Email użytkownika</label>
            <input type="text" name="email" placeholder="np. user@example.com" />
        </div>
        <div class="field">
            <label>Rola</label>
            <select name="role">
                <option value="member">member</option>
                <option value="admin">admin</option>
                <option value="viewer">viewer</option>
            </select>
        </div>
        <button class="btn btn-primary" type="submit">Dodaj</button>
    </form>
</div>
{% endif %}

{% if role == 'owner' %}
<div class="card card-ownership-warning">
    <h2 class="ownership-warning-title">⚠️ Transfer własności projektu</h2>
    <p class="muted mb-14">
        Przekazanie własności projektu spowoduje zmianę Twojej roli na <strong>admin</strong>,
        a wybrany użytkownik stanie się nowym właścicielem z pełną kontrolą nad projektem.
    </p>
    <form method="post" action="{{ url_for('projects.transfer_ownership', project_id=project.id) }}"
        data-confirm="Czy na pewno chcesz przekazać własność tego projektu? Tej operacji nie można cofnąć.">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="field">
            <label>Wybierz nowego właściciela</label>
            <select name="new_owner_id" required>
                <option value="">-- Wybierz użytkownika --</option>
                {% for m in memberships %}
                {% if m.role != 'owner' %}
                <option value="{{ m.user.id }}">{{ m.user.name }} ({{ m.user.email }}) - {{ m.role }}</option>
                {% endif %}
                {% endfor %}
            </select>
        </div>
        <button class="btn btn-danger" type="submit">Przekaż własność</button>
    </form>
</div>
{% endif %}
{% endblock %}